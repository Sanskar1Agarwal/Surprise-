<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Happy Birthday ðŸŽˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    margin:0;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    background:linear-gradient(#fff0f5,#ffe4ec);
    font-family:Arial,sans-serif;
}
.page{
    display:none;
    flex-direction:column;
    align-items:center;
    width:100%;
    max-width:600px;
}
.page.active{display:flex}
h1{
    color:#d6336c;
    font-size:clamp(32px,7vw,56px);
    white-space:nowrap;
}
button{
    padding:14px 30px;
    font-size:18px;
    border:none;
    border-radius:30px;
    background:#ff4d6d;
    color:#fff;
    cursor:pointer;
}
#micBar{
    width:220px;
    height:10px;
    background:#ffd6e0;
    border-radius:10px;
    overflow:hidden;
    margin-bottom:12px;
}
#micLevel{
    height:100%;
    width:0%;
    background:#ff4d6d;
}
canvas{
    width:100%;
    max-width:520px;
    height:auto;
}
</style>
</head>

<body>

<div id="page1" class="page active">
    <h1>Happy Birthday ðŸŽˆ</h1>
    <button id="startBtn">Start ðŸŽ‚</button>
</div>

<div id="page2" class="page">
    <div id="micBar"><div id="micLevel"></div></div>
    <canvas id="cake" width="520" height="520"></canvas>
</div>

<script>
/* PAGE SWITCH */
const startBtn=document.getElementById("startBtn");
const page1=document.getElementById("page1");
const page2=document.getElementById("page2");

startBtn.onclick=async()=>{
    page1.classList.remove("active");
    page2.classList.add("active");
    await startMic();
};

/* CANVAS */
const canvas=document.getElementById("cake");
const ctx=canvas.getContext("2d");

const center={x:canvas.width/2,y:canvas.height/2};
const radius=160;
const cakeHeight=70;

let flameOn=true;
let flameT=0;
let cuts=0;
const maxCuts=6;

let slices=[{start:0,end:Math.PI*2,offset:0}];

/* DRAW CAKE â€” CORRECT SOLID SLICES */
function drawCake(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    slices.forEach(s=>{
        const mid=(s.start+s.end)/2;
        const ox=s.offset*Math.cos(mid);
        const oy=s.offset*Math.sin(mid);

        const cx=center.x+ox;
        const cy=center.y+oy;

        /* INNER CUT FACE (SPONGE) */
        ctx.fillStyle="#a0522d";
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.lineTo(
            cx + radius*Math.cos(s.start),
            cy + radius*Math.sin(s.start)
        );
        ctx.lineTo(
            cx + radius*Math.cos(s.start),
            cy + radius*Math.sin(s.start) + cakeHeight
        );
        ctx.lineTo(cx,cy + cakeHeight);
        ctx.closePath();
        ctx.fill();

        /* OUTER SPONGE WALL */
        ctx.fillStyle="#8b4513";
        ctx.beginPath();
        ctx.arc(cx,cy+cakeHeight,radius,s.start,s.end);
        ctx.arc(cx,cy,radius,s.end,s.start,true);
        ctx.closePath();
        ctx.fill();

        /* TOP CREAM */
        ctx.fillStyle="#ff8fab";
        ctx.beginPath();
        ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,radius,s.start,s.end);
        ctx.closePath();
        ctx.fill();

        ctx.strokeStyle="#c9184a";
        ctx.stroke();
    });

    drawCandle();
}

/* CANDLE */
function drawCandle(){
    const x=center.x;
    const y=center.y-radius-35;

    ctx.fillStyle="#fff";
    ctx.fillRect(x-6,y,12,35);

    if(!flameOn) return;

    flameT+=0.05;
    const sway=Math.sin(flameT)*2;
    const lift=Math.cos(flameT*1.3)*3;

    ctx.save();
    ctx.translate(x+sway,y-14+lift);
    ctx.fillStyle="rgba(255,183,3,0.5)";
    ctx.beginPath();
    ctx.ellipse(0,0,10,16,0,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle="#ffb703";
    ctx.beginPath();
    ctx.ellipse(0,0,6,12,0,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
}

/* CUT CAKE */
canvas.onclick=()=>{
    if(cuts>=maxCuts) return;
    cuts++;
    const step=Math.PI*2/(cuts+1);
    slices=[];
    for(let i=0;i<cuts+1;i++){
        slices.push({
            start:i*step,
            end:(i+1)*step,
            offset:35
        });
    }
};

/* MICROPHONE (frequency based) */
async function startMic(){
    const bar=document.getElementById("micLevel");
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    await audioCtx.resume();

    const analyser=audioCtx.createAnalyser();
    analyser.fftSize=1024;

    const mic=audioCtx.createMediaStreamSource(stream);
    mic.connect(analyser);

    const freq=new Uint8Array(analyser.frequencyBinCount);
    let sustain=0;

    function listen(){
        analyser.getByteFrequencyData(freq);
        let energy=0;
        for(let i=2;i<20;i++) energy+=freq[i];
        energy/=18;

        bar.style.width=Math.min(100,energy*1.5)+"%";

        if(energy>25) sustain++;
        else sustain=0;

        if(sustain>20 && flameOn){
            flameOn=false;
        }
        requestAnimationFrame(listen);
    }
    listen();
}

/* LOOP */
function animate(){
    drawCake();
    requestAnimationFrame(animate);
}
animate();
</script>

</body>
</html>
